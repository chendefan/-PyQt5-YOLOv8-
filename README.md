# 基于PyQt5和YOLOv8的交通检测系统

基于PyQt5和YOLOv8的智能交通检测系统，支持实时目标检测、实例分割、多目标追踪、越线计数、区域计数等功能。

## ✨ 主要功能

- **🚗 交通目标检测**: 基于YOLOv8的高精度车辆、行人等目标检测
- 
- **🔄 多目标追踪**: 实时追踪多个移动目标
- **📏 越线计数**: 自定义计数线，统计车辆通过情况
- **🏠 区域计数**: 自定义计数区域，统计经过该区域的目标数量，支持点击和拖拽两种绘制模式
- **💾 自动数据保存**: 实时自动保存检测、追踪、越线和区域计数数据
- **⚙️ 设备选择**: 支持CPU/GPU设备选择，优化性能
- **📊 数据分析**: 实时统计分析和可视化
- **📁 数据导出**: 支持CSV、Excel、JSON等格式导出
- **🖥️ 中文界面**: 完全中文化的用户界面

## 🛠️ 技术栈

- **前端界面**: PyQt5
- **计算机视觉**: OpenCV, YOLOv8 (Ultralytics)
- **深度学习**: PyTorch
- **数据处理**: Pandas, NumPy
- **数据可视化**: Matplotlib, Seaborn
- **数据导出**: openpyxl, xlsxwriter

## 📋 系统要求

- Python 3.9+
- Windows 10/11 (推荐)
- 4GB+ RAM (推荐8GB+)
- 支持CUDA的显卡 (可选，用于GPU加速)

## 🚀 快速开始

### 1. 环境配置

**推荐方式A: 使用Conda**
```bash
# 创建新的conda环境
conda create -n yolov8-traffic python=3.9
conda activate yolov8-traffic

# 安装依赖包
pip install -r requirements.txt
```

**方式B: 使用系统Python**
```bash
# 确认pip可用
python -m pip --version

# 安装依赖包
python -m pip install -r requirements.txt
```

### 2. 获取项目文件

```bash
# 如果使用git
git clone <repository-url>
cd yolov8-traffic-analysis

# 或者下载并解压项目文件
```

### 3. 安装依赖包

```bash
# 安装所有依赖
pip install -r requirements.txt
```

### 4. 运行系统

```bash
# 方式1: 使用启动脚本 (推荐)
python run.py

# 方式2: 直接运行主程序
python main.py
```

### 5. 系统测试

```bash
# 运行组件测试
python test_system.py
```

## 📖 使用指南

### 主界面介绍

系统采用左右分栏布局：

- **左侧**: 视频显示区域和统计信息
- **右侧**: 控制面板，包含各项功能设置

### 基本操作流程

1. **加载视频源**
   - 点击"加载视频文件"选择本地视频
   - 或点击"开启摄像头"使用实时摄像头

2. **调整检测参数**
   - 选择设备 (CPU/GPU/自动)
   - 选择YOLOv8模型 (n/s/m/l/x)
   - 调整置信度阈值 (0.1-0.95)
   - 调整IoU阈值 (0.1-0.9)

3. **配置追踪设置**
   - 启用/禁用多目标追踪
   - 选择是否显示ID

4. **设置越线检测**
   - 启用越线检测功能
   - 在视频画面上点击两点绘制计数线
   - 查看实时计数统计

5. **设置区域计数** ⭐ 新功能
   - 启用区域计数功能
   - 选择计数模式（进入/离开/双向）
   - 选择绘制方式：
     - **点击模式**: 在视频画面上点击多个点绘制任意形状区域，右键完成
     - **画框模式**: 在视频画面上拖拽绘制矩形区域（推荐）
   - 支持清除所有区域和禁用显示
   - 查看区域计数统计

6. **自动数据保存** ⭐ 新功能
   - 检测开始时自动创建数据文件
   - 实时保存检测、追踪、越线和区域计数数据
   - 数据保存在 `saved_data` 目录下
   - 文件名包含时间戳和中文标识

7. **导出分析数据**
   - 选择导出格式 (CSV/Excel/JSON)
   - 点击导出按钮保存数据

### 区域计数功能详解

#### 绘制模式对比

| 特性 | 点击模式 | 画框模式 ⭐ 推荐 |
|------|---------|---------------|
| **操作方式** | 多次点击定义顶点 | 单次拖拽定义矩形 |
| **完成方式** | 右键完成 | 鼠标释放完成 |
| **适用场景** | 复杂不规则区域 | 简单矩形区域 |
| **操作难度** | 需要精确点击 | 简单直观 |
| **预览效果** | 多边形预览 | 矩形预览 |

#### 区域控制功能

- **启用/禁用**: 取消勾选"启用区域计数"时，区域立即从视频中消失
- **清除区域**: 点击"清除所有区域"立即移除所有绘制的区域
- **实时显示**: 所有操作立即生效，无需重启检测

### 模型选择建议

| 模型 | 速度 | 精度 | 文件大小 | 适用场景 |
|------|------|------|---------|----------|
| YOLOv8n | 最快 | 较低 | ~6MB | 实时检测、资源受限 |
| YOLOv8s | 快 | 平衡 | ~22MB | 一般应用推荐 |
| YOLOv8m | 中等 | 较高 | ~52MB | 精度要求较高 |
| YOLOv8l | 较慢 | 高 | ~88MB | 高精度需求 |
| YOLOv8x | 最慢 | 最高 | ~136MB | 最高精度要求 |

### 设备选择建议

| 设备类型 | 适用场景 | 性能表现 |
|----------|----------|-----------|
| **自动** | 推荐选项，自动检测GPU可用性 | 最优选择 |
| **CUDA (GPU)** | 有NVIDIA显卡环境 | 5-20x 加速 |
| **CPU** | 无GPU或调试环境 | 基本性能 |

**注意**: 首次使用GPU时可能需要一些初始化时间

## 📁 项目结构

```
yolov8-traffic-analysis/
├── main.py                 # PyQt5主应用程序
├── run.py                  # 启动脚本
├── config.py               # 系统配置文件
├── requirements.txt        # 依赖清单
├── test_system.py         # 系统测试脚本（如果存在）
├── utils/                 # 工具模块目录
│   ├── __init__.py        # 模块初始化
│   ├── detection.py       # YOLOv8检测模块
│   ├── tracking.py        # 多目标追踪模块
│   ├── line_crossing.py   # 越线检测模块
│   ├── area_counting.py   # 区域计数模块 ⭐ 增强功能
│   ├── data_saver.py      # 自动数据保存模块 ⭐ 新增
│   ├── analysis.py        # 数据分析模块
│   └── export.py          # 数据导出模块
├── saved_data/            # 自动保存的数据文件目录 ⭐ 新增
├── outputs/               # 输出文件目录
└── data/                  # 数据文件目录
```

## ⚙️ 配置说明

### 模型配置

系统支持多种YOLOv8模型，首次使用时会自动下载：

- `yolov8n.pt` - Nano版本 (~6MB)
- [yolov8s.pt](file://d:\文件保存\就业\qoder\yolov8s.pt) - Small版本 (~22MB) 
- `yolov8m.pt` - Medium版本 (~52MB)
- `yolov8l.pt` - Large版本 (~88MB)
- `yolov8x.pt` - Extra Large版本 (~136MB)

### 检测类别

系统基于COCO数据集，支持80个类别的目标检测，重点关注交通相关目标：

- 🚶‍♂️ 行人 (person)
- 🚲 自行车 (bicycle)  
- 🚗 汽车 (car)
- 🏍️ 摩托车 (motorcycle)
- 🚌 公交车 (bus)
- 🚛 卡车 (truck)
- 🚥 交通灯 (traffic light)
- 🛑 停车标志 (stop sign)

### 数据保存配置 ⭐ 新功能

#### 自动保存文件

系统会在检测开始时自动创建以下数据文件：

- `检测数据_YYYYMMDD_HHMMSS.csv` - 目标检测数据
- `追踪数据_YYYYMMDD_HHMMSS.csv` - 目标追踪数据  
- `越线数据_YYYYMMDD_HHMMSS.csv` - 越线计数数据
- `区域计数数据_YYYYMMDD_HHMMSS.csv` - 区域计数数据

#### 数据格式

所有数据文件采用CSV格式，包含时间戳、目标ID、坐标、类别等详细信息，便于后续分析和处理。

## 📊 数据导出格式

### CSV格式
- 结构化数据，易于Excel打开
- 适合数据分析和统计

### Excel格式
- 多工作表，包含检测、追踪、越线、区域数据
- 自动格式化，包含图表和统计

### JSON格式
- 完整的结构化数据
- 适合程序处理和API接口

## 🔧 故障排除

### 常见问题

**1. 无法加载模型**
- 确保网络连接正常（首次下载模型需要）
- 检查CUDA环境配置（GPU模式）
- 尝试使用CPU模式

**2. 视频播放卡顿**
- 降低视频分辨率
- 选择更轻量的模型 (YOLOv8n)
- 调整处理帧率

**3. 追踪效果不佳**
- 调整置信度阈值
- 优化计数线位置
- 检查光照条件

**4. 越线计数不准确**
- 重新绘制计数线位置
- 调整检测参数
- 确认目标经过计数线

**5. 区域计数问题** ⭐ 新增
- 确保区域足够大，包含目标移动路径
- 尝试使用画框模式绘制简单矩形区域
- 检查区域是否被正确启用
- 使用清除功能重新绘制区域

**6. 数据保存问题** ⭐ 新增
- 检查 `saved_data` 目录是否存在且可写
- 确认有足够的磁盘空间
- 检查文件是否被其他程序占用

### 性能优化建议

1. **硬件加速**
   - 使用NVIDIA GPU和CUDA
   - 增加系统内存

2. **参数调优**
   - 根据场景调整置信度阈值
   - 选择适合的模型大小

3. **视频预处理**
   - 调整视频分辨率
   - 优化视频编码格式

4. **区域设置优化** ⭐ 新增
   - 避免设置过多重叠的计数区域
   - 优先使用画框模式绘制规则区域
   - 定期清理不需要的区域

## 🆕 版本更新

### v2.0 主要更新 (当前版本)

#### 🏠 区域计数功能增强
- ✅ 新增画框模式，支持拖拽绘制矩形区域
- ✅ 修复区域清除和禁用显示问题
- ✅ 改进区域绘制状态管理
- ✅ 优化用户交互体验

#### 💾 自动数据保存
- ✅ 实时自动保存检测数据
- ✅ 支持检测、追踪、越线、区域计数数据
- ✅ 中文文件名和时间戳标识
- ✅ 线程安全的数据保存机制

#### 🔧 系统稳定性
- ✅ 改进PyQt5界面响应性
- ✅ 优化内存使用和性能
- ✅ 增强错误处理和用户反馈
- ✅ 完善的状态管理系统

## 🤝 开发指南

### 添加新功能

1. 在对应的utils模块中实现功能
2. 在main.py中集成UI控件
3. 更新config.py配置
4. 添加相应测试

### 自定义检测类别

修改 [config.py](file://d:\文件保存\就业\qoder\config.py) 中的类别配置：

```python
CUSTOM_CLASSES = {
    80: {'en': 'custom_object', 'zh': '自定义目标', 'color': (255, 0, 0)}
}
```

### 扩展数据保存功能

修改 `utils/data_saver.py` 中的 [AutoDataSaver](file://d:\文件保存\就业\qoder\utils\data_saver.py#L12-L244) 类来自定义数据保存格式和内容。

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 🙏 致谢

- [Ultralytics YOLOv8](https://github.com/ultralytics/ultralytics) - 强大的目标检测框架
- [PyQt5](https://www.riverbankcomputing.com/software/pyqt/) - 跨平台GUI工具包
- [OpenCV](https://opencv.org/) - 计算机视觉库
- [PyTorch](https://pytorch.org/) - 深度学习框架

## 📞 联系方式

如有问题或建议，请通过以下方式联系：

- 提交Issue: [项目Issues页面]
- 邮箱: [your-email@example.com]

---

**注意**: 
- 首次运行时系统会自动下载YOLOv8模型文件，请确保网络连接正常
- 系统会自动创建必要的目录结构（如 `saved_data` 等）
- 建议在正式使用前先进行系统测试以确保环境配置正确
```

